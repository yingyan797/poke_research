{% extends "base.html" %}

{% block content %}
<div class="flex h-screen">
    <!-- Sidebar -->
    <div class="bg-white shadow-lg" style="width: 25%;">
        <div class="p-4 border-b">
            <h1 class="text-xl font-bold text-gray-800">Pokemon Research</h1>
            <button id="new-chat-btn" class="mt-2 w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                <i class="fas fa-plus mr-2"></i>New Chat
            </button>
        </div>
        
        <div class="p-4">
            <h3 class="text-sm font-semibold text-gray-600 mb-2">Recent Chats</h3>
            <div id="chat-list">
                <!-- Chat sessions will be loaded here -->
            </div>
        </div>
        
        <div>
            <div class="bg-gray-50 p-3 rounded">
                <div class="text-xs text-gray-600">
                    <div id="cache-stats">Loading cache stats...</div>
                </div>
                <button id="cleanup-cache-btn" class="mt-2 text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300">
                    Cleanup Cache
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Chat Header -->
        <div class="bg-white shadow-sm p-4 border-b">
            <h2 id="chat-title" class="text-lg font-semibold text-gray-800">Select a chat or start a new one</h2>
        </div>
        
        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messages-container">
            <div id="welcome-message" class="text-center text-gray-500 mt-20">
                <i class="fas fa-robot text-6xl mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">Welcome to Pokemon Research Assistant</h3>
                <p>Ask me anything and I'll conduct deep research to provide you with comprehensive answers.</p>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="bg-white border-t p-4" id="input-area" style="display: none;">
            <div class="flex space-x-4">
                <input type="text" id="message-input" placeholder="Ask me anything..." 
                       class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="send-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg">
        <div class="flex items-center space-x-3">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <span>Researching your question...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class ChatbotApp {
    constructor() {
        this.currentSessionId = null;
        this.sessions = [];
        this.init();
    }
    
    init() {
        this.loadSessions();
        this.loadCacheStats();
        this.setupEventListeners();
        setInterval(() => this.loadCacheStats(), 30000); // Update every 30 seconds
    }
    
    setupEventListeners() {
        document.getElementById('new-chat-btn').addEventListener('click', () => this.createNewChat());
        document.getElementById('send-btn').addEventListener('click', () => this.sendMessage());
        document.getElementById('cleanup-cache-btn').addEventListener('click', () => this.cleanupCache());
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.sendMessage();
            }
        });

        // Note: Event listeners for rename and delete buttons are now added in renderSessions()
        // since they are dynamically created
    }
    
    async loadSessions() {
        try {
            const response = await axios.get('/api/sessions');
            this.sessions = response.data;
            this.renderSessions();
        } catch (error) {
            console.error('Error loading sessions:', error);
        }
    }
    
    async createNewChat() {
        try {
            const response = await axios.post('/api/sessions', {
                title: 'New Research Chat'
            });
            const sessionId = response.data.session_id;
            this.selectSession(sessionId);
            this.loadSessions(); // Refresh session list
        } catch (error) {
            console.error('Error creating new chat:', error);
        }
    }

    async renameChat(sessionId) {
        try {
            const titleElement = document.getElementById("title_" + sessionId);
            if (!titleElement) {
                console.error('Title element not found for session:', sessionId);
                return;
            }
            
            const newTitle = titleElement.value.trim();
            if (!newTitle) {
                alert('Please enter a valid title');
                return;
            }
            
            const response = await axios.put(`/api/sessions/${sessionId}`, {
                title: newTitle
            });
            
            // Refresh session list to show updated title
            this.loadSessions();
            
            // Update chat title if this is the current session
            if (this.currentSessionId === sessionId) {
                document.getElementById('chat-title').textContent = newTitle;
            }
            
        } catch (error) {
            console.error('Error renaming chat:', error);
            alert('Error renaming chat. Please try again.');
        }
    }
    
    async deleteChat(sessionId) {
        try {
            const confirmDelete = confirm('Are you sure you want to delete this chat?');
            if (!confirmDelete) {
                return;
            }
            
            await axios.delete(`/api/sessions/${sessionId}`);
            
            // If we're deleting the current session, clear the chat area
            if (this.currentSessionId === sessionId) {
                this.currentSessionId = null;
                document.getElementById('welcome-message').style.display = 'block';
                document.getElementById('input-area').style.display = 'none';
                document.getElementById('chat-title').textContent = 'Select a chat or start a new one';
                document.getElementById('messages-container').innerHTML = `
                    <div id="welcome-message" class="text-center text-gray-500 mt-20">
                        <i class="fas fa-robot text-6xl mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">Welcome to Pokemon Research Assistant</h3>
                        <p>Ask me anything and I'll conduct deep research to provide you with comprehensive answers.</p>
                    </div>
                `;
            }
            
            // Refresh session list
            this.loadSessions();
            
        } catch (error) {
            console.error('Error deleting chat:', error);
            alert('Error deleting chat. Please try again.');
        }
    }
    
    renderSessions() {
        const chatList = document.getElementById('chat-list');
        chatList.innerHTML = '';
        
        this.sessions.forEach(session => {
            const chatItem = document.createElement('div');
            chatItem.className = 'p-2 bg-green-50 rounded cursor-pointer hover:bg-green-100 mb-2';
            chatItem.innerHTML = `
                <div class="mb-2">
                    <textarea rows='1' style="width: 100%; font-size:small; resize: none; border: 1px solid #ddd; padding: 2px;" id='title_${session.session_id}'>${session.title}</textarea>
                </div>
                <div class="text-xs text-gray-500 flex justify-between items-center">
                    <span>${new Date(session.last_active).toLocaleString()}</span>
                    <div>
                        <button class="text-xs px-2 py-1 bg-blue-100 rounded hover:bg-blue-200 mr-1" id="rename_${session.session_id}">Rename</button>
                        <button class="text-xs px-2 py-1 bg-red-100 rounded hover:bg-red-200" id="del_${session.session_id}">Delete</button>
                    </div>
                </div>
            `;
            
            // Add click event for selecting session (but not on buttons)
            chatItem.addEventListener('click', (e) => {
                // Don't select session if clicking on rename/delete buttons
                if (e.target.tagName === 'BUTTON') {
                    return;
                }
                this.selectSession(session.session_id);
            });
            
            chatList.appendChild(chatItem);
        });
        
        // Add event listeners for dynamically created buttons
        this.sessions.forEach(session => {
            const renameBtn = document.getElementById(`rename_${session.session_id}`);
            const deleteBtn = document.getElementById(`del_${session.session_id}`);
            
            if (renameBtn) {
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent session selection
                    this.renameChat(session.session_id);
                });
            }
            
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent session selection
                    this.deleteChat(session.session_id);
                });
            }
        });
    }
    
    async selectSession(sessionId) {
        this.currentSessionId = sessionId;
        document.getElementById('welcome-message').style.display = 'none';
        document.getElementById('input-area').style.display = 'block';
        document.getElementById('chat-title').textContent = 'Research Chat';
        
        // Load messages for this session
        await this.loadMessages();
    }
    
    async loadMessages() {
        try {
            const response = await axios.get(`/api/sessions/${this.currentSessionId}/messages`);
            const messages = response.data;
            this.renderMessages(messages);
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }
    
    renderMessages(messages) {
        const container = document.getElementById('messages-container');
        container.innerHTML = '';
        
        messages.forEach(message => {
            const messageDiv = document.createElement('div');
            messageDiv.className = message.role === 'user' 
                ? 'flex justify-end' 
                : 'flex justify-start';
            
            const metadata = message.metadata ? JSON.parse(message.metadata) : {};
            
            messageDiv.innerHTML = "";
            if (message.role === 'user') {
                messageDiv.innerHTML += `
                    <div class="max-w-3/4 bg-blue-500 text-white' rounded-lg p-4 shadow">
                        <div class="text-sm mb-2">${message.content} 
                        <i class="text-xs mt-2 opacity-50">
                            (${new Date(message.timestamp).toLocaleTimeString()})</i>
                        </div></div>
                `
            } else {
                messageDiv.innerHTML += `
                    <div class="max-w-3/4 bg-white' rounded-lg p-4 shadow">
                    <div class="text-sm mb-2">
                        <i style='color: blue; cursor:help' title='Original question: ${metadata.cached_query}'> ${metadata.cached_query ? " -  Using cached result - ": ""} </i>
                        ${message.content}</div>
                    <div class="text-xs mt-2 pt-2 border-t border-gray-200">${message.reasoning} </div>
                    </div>
                    
                `
            };
            
            container.appendChild(messageDiv);
        });
        
        container.scrollTop = container.scrollHeight;
    }
    
    async sendMessage() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        
        if (!message || !this.currentSessionId) return;
        
        input.value = '';
        input.disabled = true;
        document.getElementById('send-btn').disabled = true;
        document.getElementById('loading-modal').classList.remove('hidden');
        
        try {
            const response = await axios.post(`/api/sessions/${this.currentSessionId}/messages`, {
                message: message
            });
            
            // Reload messages to show the conversation
            await this.loadMessages();
            
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Error sending message. Please try again.');
        } finally {
            input.disabled = false;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('loading-modal').classList.add('hidden');
        }
    }
    
    async loadCacheStats() {
        try {
            const response = await axios.get('/api/cache/stats');
            const stats = response.data;
            
            document.getElementById('cache-stats').innerHTML = `
                <div>Research Cache: ${stats.research_cache.entries} entries</div>
                <div>Cache Hits: ${stats.research_cache.total_hits}</div>
            `;
        } catch (error) {
            console.error('Error loading cache stats:', error);
        }
    }
    
    async cleanupCache() {
        try {
            await axios.post('/api/cache/cleanup');
            this.loadCacheStats();
            alert('Cache cleanup completed');
        } catch (error) {
            console.error('Error cleaning up cache:', error);
        }
    }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new ChatbotApp();
});
</script>
{% endblock %}